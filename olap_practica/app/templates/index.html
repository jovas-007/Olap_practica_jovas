{% extends 'base.html' %}
{% block title %}Consultas OLAP{% endblock %}
{% block content %}
<section class="card">
    <h1>Consultas sobre horarios</h1>
    <div class="query-grid">
        <form action="{{ url_for('web.run_query') }}" method="post" class="query-box">
            <input type="hidden" name="operation" value="horario_docente">
            <h2>Horario semanal de un docente</h2>
            <p>Ingresa un nombre o fragmento y obtén todos los bloques horarios agrupados por día.</p>
            <label for="docente">Docente</label>
            <input type="text" name="docente" id="docente" placeholder="Ej. Pérez" required>
            <button type="submit">Ejecutar consulta</button>
        </form>
        <form action="{{ url_for('web.run_query') }}" method="post" class="query-box" data-requires-any>
            <input type="hidden" name="operation" value="docentes_por_materia">
            <h2>Docentes que imparten una materia</h2>
            <p>Busca por clave oficial o por texto parcial del nombre de la asignatura.</p>
            <label for="clave">Clave</label>
            <input type="text" name="clave" id="clave" placeholder="Ej. MAT101" data-any-input>
            <label for="texto">Texto en nombre</label>
            <input type="text" name="texto" id="texto" placeholder="Ej. Cálculo" data-any-input>
            <small class="helper-text">Proporciona al menos un campo; si incluyes ambos se prioriza la clave.</small>
            <button type="submit">Ejecutar consulta</button>
        </form>
        <form action="{{ url_for('web.run_query') }}" method="post" class="query-box">
            <input type="hidden" name="operation" value="docentes_en_edificio">
            <h2>Docentes en un edificio a una hora</h2>
            <p>Introduce un edificio (o edificio/salón) y una hora exacta para localizar coincidencias.</p>
            <label for="edificio">Edificio o salón</label>
            <input type="text" name="edificio" id="edificio" placeholder="Ej. 1CCO4 o 1CCO4/307" required>
            <label for="hora">Hora</label>
            <input type="time" name="hora" id="hora" step="900" value="09:00" required>
            <label class="checkbox">
                <input type="checkbox" name="usar_slots"> Usar tabla de slots (si está disponible)
            </label>
            <button type="submit">Ejecutar consulta</button>
        </form>
    </div>
</section>
<section class="card info-section">
    <div class="info-header">
        <h2>Explora el cubo OLAP</h2>
        <div class="preview-toolbar">
            <div class="toolbar-group">
                <span>Cubo</span>
                <a class="btn" href="{{ url_for('web.preview', target='fact_clase') }}">fact_clase</a>
            </div>
            <div class="toolbar-group">
                <span>Vistas</span>
                <a class="btn" href="{{ url_for('web.preview', target='fact_clase_slot') }}">fact_clase_slot</a>
            </div>
            <div class="toolbar-group">
                <span>Dimensiones</span>
                <a class="btn" href="{{ url_for('web.preview', target='dim_docente') }}">docente</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_asignatura') }}">asignatura</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_grupo') }}">grupo</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_tiempo') }}">tiempo</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_espacio') }}">espacio</a>
            </div>
            <div class="toolbar-group">
                <span>Datos crudos</span>
                <a class="btn" href="{{ url_for('web.preview', target='staging') }}">staging.csv</a>
                <a class="btn" href="{{ url_for('web.preview', target='fact_ready') }}">fact_ready.csv</a>
            </div>
        </div>
    </div>
    <p>
        Las siguientes secciones describen los componentes cargados por la ETL. Úsalas como guía para
        navegar por las tablas dimensionales, las vistas agregadas y los datos crudos disponibles
        en el repositorio.
    </p>
    <div class="preview-actions">
        <div class="preview-group">
            <h3>Cubo completo</h3>
            <a class="btn" href="{{ url_for('web.preview', target='fact_clase') }}">Ver fact_clase</a>
        </div>
        <div class="preview-group">
            <h3>Vistas OLAP</h3>
            <a class="btn" href="{{ url_for('web.preview', target='fact_clase_slot') }}">Ver fact_clase_slot</a>
        </div>
        <div class="preview-group">
            <h3>Dimensiones</h3>
            <div class="btn-group">
                <a class="btn" href="{{ url_for('web.preview', target='dim_docente') }}">dim_docente</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_asignatura') }}">dim_asignatura</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_grupo') }}">dim_grupo</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_tiempo') }}">dim_tiempo</a>
                <a class="btn" href="{{ url_for('web.preview', target='dim_espacio') }}">dim_espacio</a>
            </div>
        </div>
        <div class="preview-group">
            <h3>Datos crudos</h3>
            <div class="btn-group">
                <a class="btn" href="{{ url_for('web.preview', target='staging') }}">staging.csv</a>
                <a class="btn" href="{{ url_for('web.preview', target='fact_ready') }}">fact_ready.csv</a>
            </div>
        </div>
    </div>
    <div class="info-grid">
        <article>
            <h3>Tablas base del cubo</h3>
            <ul>
                <li><strong>dim_docente</strong>: catálogo de profesores normalizados.</li>
                <li><strong>dim_asignatura</strong>: claves y nombres de materias por programa.</li>
                <li><strong>dim_grupo</strong>: NRC, sección y bandera de cursos cruzados.</li>
                <li><strong>dim_tiempo</strong>: códigos de día y orden cronológico.</li>
                <li><strong>dim_espacio</strong>: edificios y salones disponibles.</li>
                <li><strong>fact_clase</strong>: hechos de clase con periodo, plan y horario.</li>
            </ul>
            <p class="mini-note">Consulta los DDL completos en <code>data/dw/schema_mysql.sql</code> o <code>data/dw/schema_postgres.sql</code>.</p>
        </article>
        <article>
            <h3>Vistas y consultas analíticas</h3>
            <ul>
                <li><strong>fact_clase_slot</strong>: vista opcional de slots de 60 minutos (archivo <code>data/dw/views.sql</code>).</li>
                <li><strong>Consultas OLAP</strong>: definidas en <code>data/dw/queries.sql</code> para docente, materia y edificio.</li>
                <li><strong>Índices</strong>: scripts en <code>data/dw/indexes.sql</code> optimizan búsquedas por docente y espacio.</li>
            </ul>
            <p class="mini-note">Aplica las vistas después del esquema para habilitar la opción de slots desde el formulario.</p>
        </article>
        <article>
            <h3>Datos crudos y etapas de depuración</h3>
            <ul>
                <li><strong>data/raw/</strong>: PDFs originales extraídos desde Servicios Escolares.</li>
                <li><strong>data/staging/staging.csv</strong>: resultado directo del extractor.</li>
                <li><strong>data/staging/fact_ready.csv</strong>: dataset listo para carga en el DW.</li>
            </ul>
            <p class="mini-note">Estos archivos permiten auditar la limpieza (por ejemplo, profesores normalizados y horarios divididos por día).</p>
        </article>
    </div>
</section>
<script>
document.querySelectorAll('form[data-requires-any]').forEach(form => {
    form.addEventListener('submit', event => {
        const inputs = Array.from(form.querySelectorAll('[data-any-input]'));
        const hasValue = inputs.some(input => input.value.trim().length > 0);
        if (!hasValue) {
            const first = inputs[0];
            first.setCustomValidity('Indica una clave o un texto de materia antes de continuar');
            first.reportValidity();
            setTimeout(() => first.setCustomValidity(''), 0);
            event.preventDefault();
        }
    });
});
</script>
{% endblock %}
